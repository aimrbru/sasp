name: Build and Deploy Documentation

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üì¶ Install LibreOffice
        run: |
          sudo apt-get update
          sudo apt-get install -y libreoffice

      - name: üìã Install Python packages
        run: |
          pip install --upgrade pip
          pip install PyYAML Jinja2 markupsafe python-docx odfpy click colorama

      - name: üèóÔ∏è Generate documents
        run: |
          echo "üèóÔ∏è Generating GOST documents..."
          python docs/scripts/builders/build_docs.py all
          echo "‚úÖ Documents generated"

      - name: üìÑ Create PDF folder in web
        run: |
          echo "üìÑ Creating PDF folder..."
          mkdir -p docs/output/web/pdf
          
          # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ PDF —Ñ–∞–π–ª—ã
          if ls docs/output/pdf/*.pdf 1> /dev/null 2>&1; then
            echo "Found PDF files:"
            ls -la docs/output/pdf/*.pdf
            cp docs/output/pdf/*.pdf docs/output/web/pdf/
            echo "‚úÖ PDFs copied to web/pdf/"
            ls -la docs/output/web/pdf/*.pdf
          else
            echo "‚ö†Ô∏è No PDF files found"
            # –°–æ–∑–¥–∞–µ–º placeholder
            echo "PDF files will be available after build" > docs/output/web/pdf/placeholder.txt
          fi

      - name: üåê Generate website
        run: |
          echo "üåê Generating website..."
          python docs/scripts/builders/build_site.py
          
          # –°–æ–∑–¥–∞–µ–º .nojekyll
          touch docs/output/web/.nojekyll
          
          # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π pdf_viewer.html –µ—Å–ª–∏ –Ω–µ—Ç
          if [ ! -f "docs/output/web/pdf_viewer.html" ]; then
            echo "Creating pdf_viewer.html..."
            cat > docs/output/web/pdf_viewer.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–ü—Ä–æ—Å–º–æ—Ç—Ä PDF</title>
    <style>
        body { margin: 0; padding: 20px; background: #0f172a; color: #e2e8f0; font-family: sans-serif; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .title { font-size: 24px; color: #60a5fa; }
        .btn { padding: 10px 20px; background: #3b82f6; color: white; border-radius: 8px; text-decoration: none; }
        .viewer { width: 100%; height: calc(100vh - 100px); border: none; border-radius: 12px; }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="title" id="title">PDF Viewer</h1>
        <a href="index.html" class="btn">‚Üê –ù–∞–∑–∞–¥</a>
    </div>
    <iframe id="viewer" class="viewer"></iframe>
    <script>
        const params = new URLSearchParams(window.location.search);
        const file = params.get('file');
        if (file) {
            document.getElementById('title').textContent = decodeURIComponent(file);
            document.getElementById('viewer').src = 
                `https://mozilla.github.io/pdf.js/web/viewer.html?file=pdf/${encodeURIComponent(file)}`;
        }
    </script>
</body>
</html>
EOF
          fi

      - name: üìä Verify files before deploy
        run: |
          echo "=== Files to deploy ==="
          echo "HTML files:"
          find docs/output/web -name "*.html" -type f | sort
          echo ""
          echo "PDF files:"
          find docs/output/web -name "*.pdf" -type f | sort
          echo ""
          echo "Total files in web/:"
          find docs/output/web -type f | wc -l

      - name: üì§ Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/output/web
          publish_branch: gh-pages
          force_orphan: false
          enable_jekyll: false