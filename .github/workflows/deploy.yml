name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install --quiet --no-cache-dir -r docs/scripts/requirements.txt
          python -m pip install reportlab python-docx jinja2 pyyaml PyYAML

      - name: Install LibreOffice for PDF conversion
        run: |
          echo "üìÑ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ LibreOffice –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ PDF..."
          sudo apt-get update
          sudo apt-get install -y libreoffice-core libreoffice-writer
          libreoffice --version

      - name: Build PDF documentation
        run: |
          echo "üìÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF —Ñ–∞–π–ª–æ–≤..."
          cd ${{ github.workspace }}/docs/scripts/builders
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞
          if [ -f "build_docs.py" ]; then
            echo "‚úÖ –ù–∞–π–¥–µ–Ω build_docs.py"
            python build_docs.py all --path ${{ github.workspace }}
          else
            echo "‚ùå build_docs.py –Ω–µ –Ω–∞–π–¥–µ–Ω"
            ls -la
            exit 1
          fi
          
          echo "üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö PDF:"
          if [ -d "${{ github.workspace }}/docs/output/pdf" ]; then
            ls -la ${{ github.workspace }}/docs/output/pdf/
          else
            echo "‚ùå –ü–∞–ø–∫–∞ PDF –Ω–µ —Å–æ–∑–¥–∞–Ω–∞"
            mkdir -p ${{ github.workspace }}/docs/output/pdf
          fi

      - name: Build HTML site
        run: |
          echo "üåê –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML —Å–∞–π—Ç–∞..."
          cd ${{ github.workspace }}/docs/scripts/builders
          
          if [ -f "build_site.py" ]; then
            echo "‚úÖ –ù–∞–π–¥–µ–Ω build_site.py"
            python build_site.py
          else
            echo "‚ùå build_site.py –Ω–µ –Ω–∞–π–¥–µ–Ω"
            ls -la
            exit 1
          fi

      - name: Prepare for deployment
        run: |
          echo "üìã –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –¥–µ–ø–ª–æ—è..."
          
          # –°–æ–∑–¥–∞–µ–º .nojekyll
          touch ${{ github.workspace }}/docs/output/web/.nojekyll
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤ web –ø–∞–ø–∫–µ
          echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ web –ø–∞–ø–∫–∏:"
          ls -la ${{ github.workspace }}/docs/output/web/
          
          echo "üìÅ PDF —Ñ–∞–π–ª—ã:"
          if [ -d "${{ github.workspace }}/docs/output/pdf" ]; then
            ls -la ${{ github.workspace }}/docs/output/pdf/
            
            # –ö–æ–ø–∏—Ä—É–µ–º PDF –≤ web –ø–∞–ø–∫—É –µ—Å–ª–∏ –∏—Ö —Ç–∞–º –Ω–µ—Ç
            if [ ! -d "${{ github.workspace }}/docs/output/web/pdf" ]; then
              mkdir -p ${{ github.workspace }}/docs/output/web/pdf
            fi
            
            cp ${{ github.workspace }}/docs/output/pdf/*.pdf ${{ github.workspace }}/docs/output/web/pdf/ 2>/dev/null || echo "–ù–µ—Ç PDF –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è"
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/output/web
          publish_branch: gh-pages
          force_orphan: true
          keep_files: false