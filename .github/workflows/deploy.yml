name: Build and Deploy Documentation

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Setup Python with cache
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Cache apt packages
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/apt
            /var/lib/apt/lists
          key: ${{ runner.os }}-apt-${{ hashFiles('.github/apt-packages.txt') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: ğŸ“¦ Install system dependencies
        run: |
          if ! dpkg -l | grep -q libreoffice; then
            echo "Installing LibreOffice..."
            sudo apt-get update
            sudo apt-get install -y libreoffice
          else
            echo "âœ… LibreOffice already installed"
          fi

      - name: ğŸ“‹ Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install PyYAML Jinja2 markupsafe python-docx odfpy click colorama

      - name: ğŸ—ï¸ Generate documents
        run: |
          echo "ğŸ—ï¸ Generating GOST documents..."
          python docs/scripts/builders/build_docs.py all
          echo "âœ… Documents generated in docs/output/pdf/"

      - name: ğŸ“„ Copy PDFs to web folder
        run: |
          echo "ğŸ“„ Preparing PDFs for website..."
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ°Ğ¿ĞºÑƒ pdf Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ web
          mkdir -p docs/output/web/pdf
          
          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ PDF Ñ„Ğ°Ğ¹Ğ»Ñ‹
          if [ -d "docs/output/pdf" ] && [ "$(ls -A docs/output/pdf/*.pdf 2>/dev/null)" ]; then
            echo "Found PDF files:"
            ls -la docs/output/pdf/*.pdf
            
            # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ² web/pdf
            cp docs/output/pdf/*.pdf docs/output/web/pdf/
            
            echo "âœ… PDFs copied to web/pdf/:"
            ls -la docs/output/web/pdf/*.pdf
          else
            echo "âš ï¸ No PDFs generated in docs/output/pdf/"
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ placeholder Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑĞ°Ğ¹Ñ‚ Ğ½Ğµ Ğ¿Ğ°Ğ´Ğ°Ğ»
            echo "PDF files will be available after build" > docs/output/web/pdf/README.txt
          fi

      - name: ğŸŒ Generate website
        run: |
          echo "ğŸŒ Generating website..."
          python docs/scripts/builders/build_site.py
          
          # Ğ’Ğ°Ğ¶Ğ½Ğ¾ Ğ´Ğ»Ñ GitHub Pages
          touch docs/output/web/.nojekyll
          
          echo "âœ… Website generated with PDF links"

      - name: ğŸ“¤ Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/output/web
          publish_branch: gh-pages
          force_orphan: false
          enable_jekyll: false