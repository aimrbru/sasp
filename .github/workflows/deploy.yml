name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install --quiet --no-cache-dir -r docs/scripts/requirements.txt
          python -m pip install reportlab python-docx jinja2 pyyaml

      - name: Build PDF documentation
        run: |
          echo "ðŸ“„ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ PDF Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
          cd docs/scripts/builders
          python build_docs.py all
          
          echo "ðŸ“ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ñ… PDF:"
          ls -la ../../output/pdf/ 2>/dev/null || echo "PDF Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹"

      - name: Build HTML site
        run: |
          echo "ðŸŒ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ HTML ÑÐ°Ð¹Ñ‚Ð°..."
          cd docs/scripts/builders
          python build_site.py

      - name: Copy templates
        run: |
          echo "ðŸ“‹ ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑˆÐ°Ð±Ð»Ð¾Ð½Ð¾Ð²..."
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÑÐµ Ð¸Ð· templates/web
          cp -r docs/templates/web/. docs/output/web/
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ pdf ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
          mkdir -p docs/output/web/pdf
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ PDF Ñ„Ð°Ð¹Ð»Ñ‹ ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ ÐµÑÑ‚ÑŒ
          if ls docs/output/pdf/*.pdf 1>/dev/null 2>&1; then
            cp -r docs/output/pdf/*.pdf docs/output/web/pdf/
            echo "âœ… PDF Ñ„Ð°Ð¹Ð»Ñ‹ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹"
          else
            echo "âš ï¸ PDF Ñ„Ð°Ð¹Ð»Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð² docs/output/pdf/"
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð·Ð°Ð³Ð»ÑƒÑˆÐºÑƒ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
            echo "PDF Ð±ÑƒÐ´ÑƒÑ‚ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ð¿Ñ€Ð¸ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐµ" > docs/output/web/pdf/README.txt
          fi

      - name: Create .nojekyll
        run: |
          touch docs/output/web/.nojekyll

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/output/web
          publish_branch: gh-pages
          force_orphan: true