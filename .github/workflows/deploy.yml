name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --quiet --no-cache-dir -r docs/scripts/requirements.txt

      - name: Build documentation
        run: |
          # 1. Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ PDF
          python docs/scripts/builders/build_docs.py all
          # 2. Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ HTML-ÑÐ°Ð¹Ñ‚ (ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚ docs/output/web/)
          python docs/scripts/builders/build_site.py
          
          echo "ðŸ“ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ð¾ÑÐ»Ðµ build_site.py:"
          find docs/output/web/ -type f | head -20

      - name: Prepare final site
        run: |
          echo "ðŸ”„ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÐ°Ð¹Ñ‚Ð°..."
          
          # 1. ÐŸÐ ÐžÐ’Ð•Ð Ð¯Ð•Ðœ, Ð§Ð¢Ðž Ð•Ð¡Ð¢Ð¬ Ð’ templates/web
          echo "ðŸ“ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ templates/web:"
          if [ -d "docs/templates/web" ]; then
            ls -la docs/templates/web/
            echo "ðŸ“ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ templates/web/pdfjs (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ):"
            ls -la docs/templates/web/pdfjs/ 2>/dev/null || echo "pdfjs Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² templates"
          else
            echo "âŒ templates/web Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚!"
            exit 1
          fi
          
          # 2. ÐšÐžÐŸÐ˜Ð Ð£Ð•Ðœ Ð¨ÐÐ‘Ð›ÐžÐÐ« ÐŸÐžÐ’Ð•Ð Ð¥ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
          echo "ðŸ“‹ ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÑŽ ÑˆÐ°Ð±Ð»Ð¾Ð½Ñ‹..."
          if [ -d "docs/templates/web" ]; then
            # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹, Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ ÑÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ
            cp -r docs/templates/web/. docs/output/web/
            echo "âœ… Ð¨Ð°Ð±Ð»Ð¾Ð½Ñ‹ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹"
          else
            echo "âŒ ÐŸÐ°Ð¿ÐºÐ° docs/templates/web Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
            exit 1
          fi
          
          # 3. ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ PDF Ñ„Ð°Ð¹Ð»Ñ‹
          echo "ðŸ“„ ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÑŽ PDF Ñ„Ð°Ð¹Ð»Ñ‹..."
          mkdir -p docs/output/web/pdf
          if ls docs/output/pdf/*.pdf 1>/dev/null 2>&1; then
            cp -r docs/output/pdf/*.pdf docs/output/web/pdf/
            echo "âœ… PDF Ñ„Ð°Ð¹Ð»Ñ‹ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹"
          else
            echo "âš ï¸ PDF Ñ„Ð°Ð¹Ð»Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð² docs/output/pdf/"
            # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð·Ð°Ð³Ð»ÑƒÑˆÐºÑƒ
            echo "PDF Ñ„Ð°Ð¹Ð»Ñ‹ Ð±ÑƒÐ´ÑƒÑ‚ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð¿Ð¾Ð·Ð¶Ðµ" > docs/output/web/pdf/README.txt
          fi
          
          # 4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½ÑƒÑŽ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ
          echo "ðŸ“ Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° docs/output/web/:"
          find docs/output/web/ -type f -name "*.html" -o -name "*.js" -o -name "*.css" | sort
          
          echo "ðŸ“ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²:"
          check_files=(
            "pdf_viewer.html"
            "pdfjs/web/viewer.html"
            "pdfjs/build/pdf.js"
            "site_template.html"
            "index.html"
            "standards.html"
          )
          
          for file in "${check_files[@]}"; do
            if [ -f "docs/output/web/${file}" ]; then
              echo "  âœ… $file"
            else
              echo "  âŒ $file - ÐÐ• ÐÐÐ™Ð”Ð•Ð"
            fi
          done
          
          # 5. Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ Jekyll
          touch docs/output/web/.nojekyll
          echo "âœ… .nojekyll ÑÐ¾Ð·Ð´Ð°Ð½"
          
          # 6. Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ README Ð´Ð»Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸
          cat > docs/output/web/README.md << 'EOF'
          # Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð¡ÐÐ¡ÐŸ-2
          
          Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾: $(date)
          
          Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°:
          - index.html - Ð“Ð»Ð°Ð²Ð½Ð°Ñ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð°
          - user_guide.html - Ð ÑƒÐºÐ¾Ð²Ð¾Ð´ÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
          - maintenance.html - Ð ÑƒÐºÐ¾Ð²Ð¾Ð´ÑÑ‚Ð²Ð¾ Ð¿Ð¾ Ð¾Ð±ÑÐ»ÑƒÐ¶Ð¸Ð²Ð°Ð½Ð¸ÑŽ
          - api.html - Ð¡Ð¿Ñ€Ð°Ð²Ð¾Ñ‡Ð½Ð¸Ðº Ð¿Ð¾ API
          - standards.html - Ð“ÐžÐ¡Ð¢/PDF Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹
          - pdf_viewer.html - ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ PDF Ñ Ð·Ð°Ñ‰Ð¸Ñ‚Ð¾Ð¹
          - pdf/ - PDF Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹
          - pdfjs/ - Ð‘Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ° Ð´Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° PDF
          - media/ - ÐœÐµÐ´Ð¸Ð°Ñ„Ð°Ð¹Ð»Ñ‹
          
          GitHub Pages: https://aimrbru.github.io/sasp/
          EOF

      - name: Verify structure
        run: |
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹..."
          
          # ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°
          if [ ! -f "docs/output/web/pdf_viewer.html" ]; then
            echo "âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: pdf_viewer.html Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
            exit 1
          fi
          
          if [ ! -d "docs/output/web/pdfjs" ]; then
            echo "âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: pdfjs Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
            exit 1
          fi
          
          if [ ! -f "docs/output/web/pdfjs/web/viewer.html" ]; then
            echo "âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: pdfjs/web/viewer.html Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
            exit 1
          fi
          
          echo "âœ… Ð’ÑÐµ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð½Ð° Ð¼ÐµÑÑ‚Ðµ"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/output/web
          publish_branch: gh-pages
          force_orphan: true
          keep_files: false