name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libreoffice-core \
            libreoffice-writer \
            poppler-utils  # –¥–ª—è pdftoppm
          
          echo "‚úÖ –°–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
          libreoffice --version
          pdftoppm -v

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r docs/scripts/requirements.txt
          pip install img2pdf  # –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ PDF
          
          echo "‚úÖ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
          python --version

      - name: Generate documentation
        run: |
          echo "üìÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ì–û–°–¢-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏..."
          python docs/scripts/builders/build_docs.py all
          
          echo "üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö PDF:"
          ls -la docs/output/pdf/ 2>/dev/null || echo "–ü–∞–ø–∫–∞ PDF –Ω–µ —Å–æ–∑–¥–∞–Ω–∞"
          
          echo "üåê –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML —Å–∞–π—Ç–∞..."
          python docs/scripts/builders/build_site.py

      - name: Protect PDFs (convert to images)
        run: |
          echo "üõ°Ô∏è  –ó–ê–©–ò–¢–ê PDF –û–¢ –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø"
          echo "================================="
          
          # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö PDF
          mkdir -p docs/output/protected_pdf
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ PDF –¥–ª—è –∑–∞—â–∏—Ç—ã
          if [ ! -d "docs/output/pdf" ] || [ -z "$(ls -A docs/output/pdf/*.pdf 2>/dev/null)" ]; then
            echo "‚ö†Ô∏è  –ù–µ—Ç PDF —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∑–∞—â–∏—Ç—ã"
            echo "–¢–µ—Å—Ç–æ–≤—ã–π PDF" > docs/output/protected_pdf/TEST.pdf
          else
            # –ó–∞—â–∏—â–∞–µ–º –∫–∞–∂–¥—ã–π PDF —Ñ–∞–π–ª
            for input_pdf in docs/output/pdf/*.pdf; do
              if [ -f "$input_pdf" ]; then
                filename=$(basename "$input_pdf")
                output_pdf="docs/output/protected_pdf/$filename"
                
                echo ""
                echo "üîí –û–±—Ä–∞–±–æ—Ç–∫–∞: $filename"
                
                # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É
                temp_dir=$(mktemp -d)
                
                # 1. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º PDF –≤ JPEG (pdftoppm)
                echo "   üì∑ PDF ‚Üí JPEG..."
                pdftoppm \
                  -jpeg \
                  -jpegopt "quality=95" \
                  -r 150 \
                  "$input_pdf" \
                  "$temp_dir/page"
                
                # –°—á–∏—Ç–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                page_count=$(ls "$temp_dir"/page-*.jpg 2>/dev/null | wc -l)
                echo "   üìÑ –°—Ç—Ä–∞–Ω–∏—Ü: $page_count"
                
                if [ $page_count -eq 0 ]; then
                  echo "   ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å JPEG"
                  continue
                fi
                
                # 2. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º JPEG –æ–±—Ä–∞—Ç–Ω–æ –≤ PDF (img2pdf)
                echo "   üìÑ JPEG ‚Üí PDF..."
                jpeg_files=$(ls "$temp_dir"/page-*.jpg | sort)
                img2pdf $jpeg_files --output "$output_pdf"
                
                # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                if [ -f "$output_pdf" ]; then
                  size=$(stat -c%s "$output_pdf")
                  size_mb=$(echo "scale=2; $size/1024/1024" | bc)
                  echo "   ‚úÖ –ó–∞—â–∏—â–µ–Ω ($size_mb MB)"
                else
                  echo "   ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è PDF"
                fi
                
                # 4. –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
                rm -rf "$temp_dir"
              fi
            done
            
            echo ""
            echo "üìä –ò–¢–û–ì–û –ó–ê–©–ò–©–ï–ù–û:"
            ls -lh docs/output/protected_pdf/
          fi

      - name: Prepare files for deployment
        run: |
          echo "üìã –ü–û–î–ì–û–¢–û–í–ö–ê –§–ê–ô–õ–û–í –î–õ–Ø –î–ï–ü–õ–û–Ø"
          echo "================================="
          
          # 1. –ö–æ–ø–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω—ã (–≤–µ—Å—å –∫–æ–Ω—Ç–µ–Ω—Ç –∏–∑ templates/web)
          echo "üìÅ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤..."
          if [ -d "docs/templates/web" ]; then
            cp -r docs/templates/web/* docs/output/web/ 2>/dev/null || true
            echo "‚úÖ –®–∞–±–ª–æ–Ω—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"
          else
            echo "‚ö†Ô∏è  –ü–∞–ø–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
          fi
          
          # 2. –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫
          echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞–ø–æ–∫..."
          mkdir -p docs/output/web/pdf
          mkdir -p docs/output/web/media
          
          # 3. –ö–æ–ø–∏—Ä—É–µ–º –ó–ê–©–ò–©–ï–ù–ù–´–ï PDF (–Ω–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ!)
          echo "üìÑ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö PDF..."
          if [ -d "docs/output/protected_pdf" ] && [ -n "$(ls -A docs/output/protected_pdf/*.pdf 2>/dev/null)" ]; then
            cp docs/output/protected_pdf/*.pdf docs/output/web/pdf/
            echo "‚úÖ –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ PDF —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"
          else
            echo "‚ö†Ô∏è  –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ PDF –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ..."
            if [ -d "docs/output/pdf" ] && [ -n "$(ls -A docs/output/pdf/*.pdf 2>/dev/null)" ]; then
              cp docs/output/pdf/*.pdf docs/output/web/pdf/
              echo "‚úÖ –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ PDF —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã (–Ω–µ –∑–∞—â–∏—â–µ–Ω—ã!)"
            else
              echo "‚ùå PDF —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
              # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
              echo "–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π PDF –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∞–π—Ç–∞" > docs/output/web/pdf/TEST.pdf
            fi
          fi
          
          # 4. –ö–æ–ø–∏—Ä—É–µ–º –º–µ–¥–∏–∞ —Ñ–∞–π–ª—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
          if [ -d "docs/output/media" ]; then
            cp -r docs/output/media/* docs/output/web/media/ 2>/dev/null || true
          fi
          
          # 5. –°–æ–∑–¥–∞–µ–º .nojekyll (–≤–∞–∂–Ω–æ –¥–ª—è GitHub Pages)
          touch docs/output/web/.nojekyll
          
          # 6. –°–æ–∑–¥–∞–µ–º robots.txt (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
          echo "User-agent: *" > docs/output/web/robots.txt
          echo "Allow: /" >> docs/output/web/robots.txt
          
          # 7. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
          echo ""
          echo "üìÅ –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê docs/output/web/:"
          ls -la docs/output/web/
          
          echo ""
          echo "üìÑ PDF —Ñ–∞–π–ª—ã –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:"
          ls -lh docs/output/web/pdf/ 2>/dev/null || echo "–ü–∞–ø–∫–∞ pdf –ø—É—Å—Ç–∞"
          
          echo ""
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤:"
          [ -f "docs/output/web/pdf_viewer.html" ] && echo "‚úÖ pdf_viewer.html" || echo "‚ùå pdf_viewer.html"
          [ -f "docs/output/web/.nojekyll" ] && echo "‚úÖ .nojekyll" || echo "‚ùå .nojekyll"
          [ -d "docs/output/web/pdfjs" ] && echo "‚úÖ pdfjs/ –ø–∞–ø–∫–∞" || echo "‚ùå pdfjs/ –ø–∞–ø–∫–∞"
          [ -d "docs/output/web/pdf" ] && echo "‚úÖ pdf/ –ø–∞–ø–∫–∞" || echo "‚ùå pdf/ –ø–∞–ø–∫–∞"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/output/web
          publish_branch: gh-pages
          force_orphan: true  # –û—á–∏—â–∞–µ—Ç –≤–µ—Ç–∫—É –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: Deployment summary
        run: |
          echo ""
          echo "üéâ –î–ï–ü–õ–û–ô –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù"
          echo "=========================="
          echo "üåê –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É:"
          echo "   https://aimrbru.github.io/sasp/"
          echo ""
          echo "üìÅ –í–µ—Ç–∫–∞: gh-pages"
          echo "üöÄ GitHub Pages –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 1-2 –º–∏–Ω—É—Ç"