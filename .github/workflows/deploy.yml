name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Install LibreOffice
        run: |
          sudo apt-get update
          sudo apt-get install -y libreoffice-core libreoffice-writer
          libreoffice --version

      - name: Generate documentation
        run: |
          pip install -r docs/scripts/requirements.txt
          
          echo "üìÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF..."
          python docs/scripts/builders/build_docs.py all
          
          echo "üåê –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∞–π—Ç–∞..."
          python docs/scripts/builders/build_site.py

      - name: Prepare files for deployment
        run: |
          echo "üìã –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –¥–µ–ø–ª–æ—è..."
          
          # 1. –ö–æ–ø–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω—ã
          cp -r docs/templates/web/* docs/output/web/
          
          # 2. –°–û–ó–î–ê–ï–ú –ü–ê–ü–ö–£ pdf (–≤–∞–∂–Ω–æ!)
          mkdir -p docs/output/web/pdf
          
          # 3. –ö–æ–ø–∏—Ä—É–µ–º PDF —Ñ–∞–π–ª—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
          echo "üìÅ –ü—Ä–æ–≤–µ—Ä—è–µ–º PDF —Ñ–∞–π–ª—ã..."
          if [ -d "docs/output/pdf" ]; then
            echo "‚úÖ –ü–∞–ø–∫–∞ docs/output/pdf —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            ls -la docs/output/pdf/
            
            # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ PDF
            for pdf in docs/output/pdf/*.pdf; do
              if [ -f "$pdf" ]; then
                cp "$pdf" docs/output/web/pdf/
                echo "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: $(basename $pdf)"
              fi
            done
          else
            echo "‚ùå –ü–∞–ø–∫–∞ docs/output/pdf –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
            echo "–¢–µ—Å—Ç–æ–≤—ã–π PDF" > docs/output/web/pdf/TEST.pdf
          fi
          
          # 4. –°–æ–∑–¥–∞–µ–º .nojekyll
          touch docs/output/web/.nojekyll
          
          # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          echo ""
          echo "üìä –ò–¢–û–ì:"
          echo "PDF —Ñ–∞–π–ª–æ–≤ –≤ web/pdf/:"
          ls -la docs/output/web/pdf/ || echo "–ü–∞–ø–∫–∞ –ø—É—Å—Ç–∞"
          echo ""
          echo "–í—Å–µ —Ñ–∞–π–ª—ã –≤ output/web/:"
          ls -la docs/output/web/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/output/web
          publish_branch: gh-pages
          force_orphan: true