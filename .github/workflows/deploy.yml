name: Build and Deploy Documentation

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üêç Setup Python with pip cache
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Python –ø–∞–∫–µ—Ç–æ–≤

      - name: üì¶ Cache apt packages
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/apt
            /var/lib/apt/lists
          key: ${{ runner.os }}-apt-${{ hashFiles('.github/apt-packages.txt') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: üì¶ Install system dependencies
        run: |
          # –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ LibreOffice
          if ! command -v libreoffice &> /dev/null; then
            echo "Installing LibreOffice..."
            sudo apt-get update
            sudo apt-get install -y libreoffice
          else
            echo "‚úÖ LibreOffice already installed"
            libreoffice --version | head -1
          fi

      - name: üìã Install Python packages
        run: |
          pip install --upgrade pip
          pip install PyYAML Jinja2 markupsafe python-docx odfpy click colorama

      - name: üèóÔ∏è Generate documents
        run: |
          echo "üèóÔ∏è Generating GOST documents..."
          python docs/scripts/builders/build_docs.py all
          echo "‚úÖ Documents generated in docs/output/pdf/"

      - name: üìÑ Copy PDFs to web folder
        run: |
          echo "üìÑ Preparing PDFs for website..."
          
          # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è PDF
          mkdir -p docs/output/web/pdf
          
          # –ö–æ–ø–∏—Ä—É–µ–º PDF —Ñ–∞–π–ª—ã
          if [ -d "docs/output/pdf" ] && [ "$(ls -A docs/output/pdf/*.pdf 2>/dev/null)" ]; then
            echo "Found PDF files:"
            ls -la docs/output/pdf/*.pdf
            
            # –ö–æ–ø–∏—Ä—É–µ–º
            cp docs/output/pdf/*.pdf docs/output/web/pdf/
            
            echo "‚úÖ PDFs ready in web/pdf/:"
            ls -la docs/output/web/pdf/*.pdf
          else
            echo "‚ö†Ô∏è No PDFs to copy"
            # –ü—É—Å—Ç–æ–π —Ñ–∞–π–ª —á—Ç–æ–±—ã –ø–∞–ø–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞
            touch docs/output/web/pdf/.keep
          fi

      - name: üåê Generate website with correct PDF paths
        run: |
          echo "üåê Generating website..."
          python docs/scripts/builders/build_site.py
          touch docs/output/web/.nojekyll
          
          # –°–æ–∑–¥–∞–µ–º pdf_viewer.html —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—É—Ç—è–º–∏
          cat > docs/output/web/pdf_viewer.html << 'EOF'
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; margin-bottom: 20px; border-bottom: 1px solid #334155; }
        .title { font-size: 24px; color: #60a5fa; }
        .btn { padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; text-decoration: none; }
        .viewer-container { width: 100%; height: calc(100vh - 180px); border-radius: 12px; overflow: hidden; background: #1e293b; }
        iframe { width: 100%; height: 100%; border: none; }
        .debug { background: #1e293b; padding: 10px; margin-top: 10px; border-radius: 5px; font-size: 12px; color: #94a3b8; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title" id="docTitle">–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞</h1>
            <a href="standards.html" class="btn">‚Üê –ù–∞–∑–∞–¥ –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º</a>
        </div>
        
        <div class="viewer-container">
            <iframe id="pdfViewer" title="PDF Viewer"></iframe>
        </div>
        
        <div class="debug" id="debugInfo"></div>
    </div>
    
    <script>
        // –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const pdfFile = urlParams.get('file');
        
        if (!pdfFile) {
            document.getElementById('docTitle').textContent = '–û—à–∏–±–∫–∞: —Ñ–∞–π–ª –Ω–µ —É–∫–∞–∑–∞–Ω';
            document.getElementById('pdfViewer').srcdoc = '<div style="padding: 40px; text-align: center; color: #ef4444;"><p>–§–∞–π–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–µ —É–∫–∞–∑–∞–Ω</p><p>–ü—Ä–∏–º–µ—Ä: ?file=–ê–ò–ú–£.123456.002.–ü–°.pdf</p></div>';
        } else {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const fileName = decodeURIComponent(pdfFile).replace('.pdf', '');
            document.getElementById('docTitle').textContent = fileName;
            
            // –ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–£–¢–¨: pdf/—Ñ–∞–π–ª.pdf (–±–µ–∑ 's' –Ω–∞ –∫–æ–Ω—Ü–µ!)
            const pdfUrl = `pdf/${pdfFile}`;
            const viewerUrl = `https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(window.location.origin + '/' + pdfUrl)}`;
            
            // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            document.getElementById('debugInfo').innerHTML = `
                <div>–§–∞–π–ª: ${pdfFile}</div>
                <div>PDF –ø—É—Ç—å: ${pdfUrl}</div>
                <div>–ü–æ–ª–Ω—ã–π URL: ${window.location.origin}/${pdfUrl}</div>
                <div>Viewer URL: ${viewerUrl}</div>
            `;
            
            console.log('PDF URL:', pdfUrl);
            console.log('Full PDF URL:', window.location.origin + '/' + pdfUrl);
            console.log('Viewer URL:', viewerUrl);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º PDF
            document.getElementById('pdfViewer').src = viewerUrl;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–∞
            fetch(pdfUrl)
                .then(response => {
                    if (response.ok) {
                        console.log('‚úÖ PDF –¥–æ—Å—Ç—É–ø–µ–Ω');
                    } else {
                        console.error('‚ùå PDF –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω:', response.status);
                        document.getElementById('debugInfo').innerHTML += `<div style="color: #ef4444;">–û—à–∏–±–∫–∞: PDF –Ω–µ –Ω–∞–π–¥–µ–Ω (${response.status})</div>`;
                    }
                })
                .catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:', error);
                });
        }
    </script>
</body>
</html>
EOF
          
          echo "‚úÖ Created pdf_viewer.html with correct PDF paths"