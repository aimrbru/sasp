name: Build and Deploy Documentation

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üêç Setup Python with cache
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ pip –ø–∞–∫–µ—Ç–æ–≤

      - name: üì¶ Cache apt packages
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/apt
            /var/lib/apt/lists
          key: ${{ runner.os }}-apt-${{ hashFiles('.github/apt-packages.txt') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: üì¶ Install system dependencies
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ —É–∂–µ LibreOffice
          if ! dpkg -l | grep -q libreoffice; then
            echo "Installing LibreOffice..."
            sudo apt-get update
            sudo apt-get install -y libreoffice
          else
            echo "‚úÖ LibreOffice already installed"
          fi

      - name: üìã Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install PyYAML Jinja2 markupsafe python-docx odfpy click colorama
          # –≠—Ç–∏ –ø–∞–∫–µ—Ç—ã –±—É–¥—É—Ç –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω—ã –±–ª–∞–≥–æ–¥–∞—Ä—è cache: 'pip'

      - name: üèóÔ∏è Build
        run: |
          python docs/scripts/builders/build_docs.py all
          python docs/scripts/builders/build_site.py

      - name: üì§ Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/output/web
          publish_branch: gh-pages