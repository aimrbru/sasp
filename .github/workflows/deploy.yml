name: Build and Deploy Documentation

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

# –î–ê–ñ–ï –í–ê–ñ–ù–ï–ï: –ø—Ä–∞–≤–∞ –¥–ª—è –≤—Å–µ–≥–æ workflow
permissions:
  contents: write  # –î–û–õ–ñ–ù–û –ë–´–¢–¨ write –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ –≤–µ—Ç–∫—É!
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    # –ü—Ä–∞–≤–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ job (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ –ª—É—á—à–µ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å)
    permissions:
      contents: write  # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û!
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –¥–µ–ø–ª–æ—è

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üì¶ Check and install LibreOffice
        run: |
          if ! command -v libreoffice &> /dev/null; then
            echo "Installing LibreOffice..."
            sudo apt-get update
            sudo apt-get install -y libreoffice
          else
            echo "‚úÖ LibreOffice already installed"
          fi

      - name: üìã Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install PyYAML Jinja2 markupsafe python-docx odfpy click colorama

      - name: üèóÔ∏è Generate documents (ODT/PDF)
        run: |
          echo "üèóÔ∏è Generating GOST documents..."
          python docs/scripts/builders/build_docs.py all
          echo "‚úÖ Documents generated"

      - name: üåê Generate documentation website
        run: |
          echo "üåê Generating documentation website..."
          python docs/scripts/builders/build_site.py
          echo "‚úÖ Website generated"

      - name: üìÅ Verify generated files
        run: |
          echo "Generated files:"
          ls -la docs/output/web/ 2>/dev/null || echo "No web directory"
          echo ""
          if [ -f "docs/output/web/index.html" ]; then
            echo "‚úÖ index.html exists"
          else
            echo "‚ùå index.html not found"
            exit 1
          fi

      - name: üì§ Deploy to gh-pages branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          # –£–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–∫–µ–Ω —è–≤–Ω–æ
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/output/web
          publish_branch: gh-pages
          force_orphan: true  # –û—á–∏—â–∞–µ–º –≤–µ—Ç–∫—É –∫–∞–∂–¥—ã–π —Ä–∞–∑
          enable_jekyll: false  # –ù–µ –Ω—É–∂–Ω–æ –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∞–π—Ç–æ–≤
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'